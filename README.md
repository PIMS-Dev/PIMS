# PIMS
普罗米修斯实时聊天系统

## 总架构
### 用户需要知道的
1.用户名  
2.密码

### 注册流程
1.客户端获取用户名和密码  
2.客户端把用户名进行两次sha256运算后作为用户id发送至服务器进行查重，确认没有重复就进行下一步  
3.客户端把密码进行两次sha256运算，并把输出分割成两组作为用户数据aes128-cbc的iv和key  
4.客户端随机生成一对rsa2048密钥，在用户数据里放入私钥  
5.客户端把统计数据用aes128-cbc加密后带上公钥、用户id发送至服务器，服务器储存用户id、rsa2048公钥和加密后的用户数据，至此注册完成

### 登陆流程
1.客户端把密码进行两次sha256运算，并把输出分割成两组作为用户数据aes128-cbc的iv和key  
2.客户端把用户名进行两次sha256运算后把结果发送至服务器来获取对应的aes128-cbc加密后的用户数据
3.客户端用在第一步里获取的iv和key对用户数据进行解密，至此登陆完成

### 创建聊天
1.在登陆完成后，A客户端向获取要拉进聊天的人，并通过两次sha256后向服务器确认是否有这些人同时获取这些人的公钥，假设A拉B进来  
2.A客户端随机生成一个aes128-cbc的key和iv还有一个rsa2048密钥，并获取群聊名称，通过群聊名称和当前时间再加上一个随机数进行两次sha256成为群聊id  
3.A客户端用所有要邀请的人的公钥加密群聊id、aes128-cbc的key和iv、rsa2048的私钥最作为群聊邀请信息，还有rsa2048公钥、群聊id并发送至服务器  
4.服务器获取到A客户端发来的数据后，把各人对应密钥加密的群聊邀请信息放入各人对应的邀请缓冲区内，并把群聊id和对应公钥放入群里
5.B的客户端用自己的用户id、当前时间和一个随机数构建一个查询包，并用自己的私钥进行数字签名  
6.服务器确认查询包数字签名正确后把邀请缓冲区的内容下发给B客户端  
7.B客户端解密邀请信息，把群聊id、aes-cbc的key和iv和rsa2048的密钥加入自己的用户数据并重新把用户数据加密后和要删除的邀请信息加上数字签名发回服务器  
8.服务器收到并确认数字签名后把用户数据更新并把要求删除的邀请信息从邀请缓冲区内删除，至此创建聊天完成

### 进行通信
1.A客户端获取要发送的消息，在消息内加入消息类型并用对应群聊id的aes128-cbc的密钥加密消息，带上群聊id和当前时间并用对应的rsa2048私钥进行数字签名后发送至服务器上  
2.服务器收到消息后通过对应群聊的数字签名确认消息有效后把消息放入对应群里的消息记录  
3.B客户端定时构建一个消息请求包，包括群聊id、上次请求时间、当前时间和一个随机数并用对应群聊的rsa2048私钥对它进行数字签名后发至服务器  
4.服务器收到请求包确认数字签名后把对应时间段里的消息发给B客户端  
5.B客户端收到消息后用群聊对应aes-cbc密钥进行解密，至此一次通信完成
